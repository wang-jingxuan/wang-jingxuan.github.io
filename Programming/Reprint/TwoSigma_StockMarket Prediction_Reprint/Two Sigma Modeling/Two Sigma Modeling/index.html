
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jingxuan Wang">
      
      
        <meta name="author" content="Jingxuan Wang">
      
      
        <link rel="canonical" href="https://wang-jingxuan.github.io/Programming/Reprint/TwoSigma_StockMarket%20Prediction_Reprint/Two%20Sigma%20Modeling/Two%20Sigma%20Modeling/">
      
      
        <link rel="prev" href="../../Two%20sigma%20Merging%20and%20Data%20prepocessing/">
      
      
        <link rel="next" href="../../../../../AboutMe/">
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>Modeling - Jingxuan Wang</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../mkdocs/css/no-footer.css">
    
      <link rel="stylesheet" href="../../../../../mkdocs/css/unordered-list-symbols.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="amber" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#applying-models-on-data" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Jingxuan Wang" class="md-header__button md-logo" aria-label="Jingxuan Wang" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jingxuan Wang
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Modeling
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="amber" data-md-color-accent="cyan"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="cyan"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/wang-jingxuan/wang-jingxuan.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    wang-jingxuan.github.io
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../CV/" class="md-tabs__link">
        
  
    
  
  CV

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../../" class="md-tabs__link">
          
  
    
  
  Programming

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../AboutMe/" class="md-tabs__link">
        
  
    
  
  About Me

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Jingxuan Wang" class="md-nav__button md-logo" aria-label="Jingxuan Wang" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Jingxuan Wang
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/wang-jingxuan/wang-jingxuan.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    wang-jingxuan.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../CV/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CV
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Programming
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Programming
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../MachineLearning/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Machine Learning
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Machine Learning
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../MachineLearning/Perfume_Grouping/Perfume_Grouping/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Clustering Data
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../MachineLearning/pytorch_logistic_regerssion/pytorch_logistic_regerssion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Logistic Regression
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../MachineLearning/pytorch_DNN/pytorch_DNN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deep Neural Networks (DNN)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../MachineLearning/pytorch_convolutional_neural_network%28CNN%29/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Convolutional Neural Network (CNN)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../MachineLearning/mnist_image_classification_DNN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Image Classification
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../MachineLearning/pytorch_SVM_algorithm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SVM Algorithm
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Reprint - Two Sigma Stock Market Prediction
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Reprint - Two Sigma Stock Market Prediction
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Two%20Sigma%20Market%20EDA/Two%20Sigma%20Market%20EDA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Market EDA
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Two%20Sigma%20News%20EDA/Two%20Sigma%20News%20EDA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    News EDA
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Two%20sigma%20Merging%20and%20Data%20prepocessing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Merging and Data preprocessing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Modeling
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Modeling
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#removing-news-data" class="md-nav__link">
    <span class="md-ellipsis">
      Removing news data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defining-custom-metric-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Defining custom metric functions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#time-series-split" class="md-nav__link">
    <span class="md-ellipsis">
      Time series split
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../AboutMe/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About Me
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#removing-news-data" class="md-nav__link">
    <span class="md-ellipsis">
      Removing news data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defining-custom-metric-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Defining custom metric functions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#time-series-split" class="md-nav__link">
    <span class="md-ellipsis">
      Time series split
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/wang-jingxuan/wang-jingxuan.github.io/edit/main/docs/Programming/Reprint/TwoSigma_StockMarket Prediction_Reprint/Two Sigma Modeling/Two Sigma Modeling.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="applying-models-on-data">Applying models on data.<a class="headerlink" href="#applying-models-on-data" title="Permanent link">&para;</a></h1>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lightgbm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">lgb</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">confusion_matrix</span> 
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightgbm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LGBMClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalibratedClassifierCV</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">SGDRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeSeriesSplit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomizedSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="kn">import</span> <span class="n">XGBClassifier</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">traindata</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;train.csv&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">testdata</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;test.csv&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">traindata</span><span class="o">=</span><span class="n">traindata</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">testdata</span><span class="o">=</span><span class="n">testdata</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">traindata</span><span class="o">.</span><span class="n">columns</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Index([&#39;time&#39;, &#39;assetCode&#39;, &#39;assetName&#39;, &#39;volume&#39;, &#39;close&#39;, &#39;open&#39;,
       &#39;returnsClosePrevRaw1&#39;, &#39;returnsOpenPrevRaw1&#39;,
       &#39;returnsClosePrevMktres1&#39;, &#39;returnsOpenPrevMktres1&#39;,
       &#39;returnsClosePrevRaw10&#39;, &#39;returnsOpenPrevRaw10&#39;,
       &#39;returnsClosePrevMktres10&#39;, &#39;returnsOpenPrevMktres10&#39;,
       &#39;returnsOpenNextMktres10&#39;, &#39;universe&#39;, &#39;urgency&#39;, &#39;bodySize&#39;,
       &#39;companyCount&#39;, &#39;marketCommentary&#39;, &#39;sentenceCount&#39;, &#39;wordCount&#39;,
       &#39;relevance&#39;, &#39;sentimentClass&#39;, &#39;sentimentNegative&#39;, &#39;sentimentNeutral&#39;,
       &#39;sentimentPositive&#39;, &#39;sentimentWordCount&#39;, &#39;noveltyCount3D&#39;,
       &#39;volumeCounts3D&#39;, &#39;headlinelength&#39;,
       &#39;returnsClosePrevMktres10_lag_3_median&#39;,
       &#39;returnsClosePrevMktres10_lag_3_max&#39;,
       &#39;returnsClosePrevMktres10_lag_3_min&#39;,
       &#39;returnsClosePrevMktres10_lag_7_median&#39;,
       &#39;returnsClosePrevMktres10_lag_7_max&#39;,
       &#39;returnsClosePrevMktres10_lag_7_min&#39;,
       &#39;returnsClosePrevMktres10_lag_14_median&#39;,
       &#39;returnsClosePrevMktres10_lag_14_max&#39;,
       &#39;returnsClosePrevMktres10_lag_14_min&#39;,
       &#39;returnsClosePrevRaw10_lag_3_median&#39;, &#39;returnsClosePrevRaw10_lag_3_max&#39;,
       &#39;returnsClosePrevRaw10_lag_3_min&#39;, &#39;returnsClosePrevRaw10_lag_7_median&#39;,
       &#39;returnsClosePrevRaw10_lag_7_max&#39;, &#39;returnsClosePrevRaw10_lag_7_min&#39;,
       &#39;returnsClosePrevRaw10_lag_14_median&#39;,
       &#39;returnsClosePrevRaw10_lag_14_max&#39;, &#39;returnsClosePrevRaw10_lag_14_min&#39;,
       &#39;open_lag_3_median&#39;, &#39;open_lag_3_max&#39;, &#39;open_lag_3_min&#39;,
       &#39;open_lag_7_median&#39;, &#39;open_lag_7_max&#39;, &#39;open_lag_7_min&#39;,
       &#39;open_lag_14_median&#39;, &#39;open_lag_14_max&#39;, &#39;open_lag_14_min&#39;,
       &#39;close_lag_3_median&#39;, &#39;close_lag_3_max&#39;, &#39;close_lag_3_min&#39;,
       &#39;close_lag_7_median&#39;, &#39;close_lag_7_max&#39;, &#39;close_lag_7_min&#39;,
       &#39;close_lag_14_median&#39;, &#39;close_lag_14_max&#39;, &#39;close_lag_14_min&#39;,
       &#39;closeopentovolume&#39;, &#39;meanvolume&#39;, &#39;meanclose&#39;, &#39;stdclose&#39;, &#39;dayofweek&#39;,
       &#39;quarter&#39;, &#39;month&#39;, &#39;year&#39;, &#39;close_30EMA&#39;, &#39;close_26EMA&#39;, &#39;close_12EMA&#39;,
       &#39;MACD&#39;, &#39;MA_7MA&#39;, &#39;MA_7MA_std&#39;, &#39;MA_7MA_BB_high&#39;, &#39;MA_7MA_BB_low&#39;,
       &#39;RSI&#39;, &#39;beta&#39;, &#39;sin_quarter&#39;, &#39;sin_dayofweek&#39;, &#39;sin_month&#39;],
      dtype=&#39;object&#39;)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">traindata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">traindata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">testdata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">testdata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">universe_test</span> <span class="o">=</span> <span class="n">testdata</span><span class="p">[</span><span class="s1">&#39;universe&#39;</span><span class="p">]</span>
<span class="n">time_test</span> <span class="o">=</span> <span class="n">testdata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
<span class="n">universe_train</span><span class="o">=</span><span class="n">traindata</span><span class="p">[</span><span class="s1">&#39;universe&#39;</span><span class="p">]</span>
<span class="n">time_train</span><span class="o">=</span><span class="n">traindata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
<span class="n">y_train</span><span class="o">=</span><span class="p">(</span><span class="n">traindata</span><span class="o">.</span><span class="n">returnsOpenNextMktres10</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
<span class="n">y_test</span><span class="o">=</span><span class="p">(</span><span class="n">testdata</span><span class="o">.</span><span class="n">returnsOpenNextMktres10</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
<span class="n">y_train1</span><span class="o">=</span><span class="n">traindata</span><span class="o">.</span><span class="n">returnsOpenNextMktres10</span>
<span class="n">y_test1</span><span class="o">=</span><span class="n">testdata</span><span class="o">.</span><span class="n">returnsOpenNextMktres10</span>
</code></pre></div>
<h2 id="removing-news-data">Removing news data<a class="headerlink" href="#removing-news-data" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span><span class="s1">&#39;returnsClosePrevRaw1&#39;</span><span class="p">,</span> <span class="s1">&#39;returnsOpenPrevRaw1&#39;</span><span class="p">,</span>
       <span class="s1">&#39;returnsClosePrevMktres1&#39;</span><span class="p">,</span> <span class="s1">&#39;returnsOpenPrevMktres1&#39;</span><span class="p">,</span>
       <span class="s1">&#39;returnsClosePrevRaw10&#39;</span><span class="p">,</span> <span class="s1">&#39;returnsOpenPrevRaw10&#39;</span><span class="p">,</span>
       <span class="s1">&#39;returnsClosePrevMktres10&#39;</span><span class="p">,</span> <span class="s1">&#39;returnsOpenPrevMktres10&#39;</span><span class="p">,</span>
       <span class="s1">&#39;returnsClosePrevMktres10_lag_3_median&#39;</span><span class="p">,</span>
       <span class="s1">&#39;returnsClosePrevMktres10_lag_3_max&#39;</span><span class="p">,</span>
       <span class="s1">&#39;returnsClosePrevMktres10_lag_3_min&#39;</span><span class="p">,</span>
       <span class="s1">&#39;returnsClosePrevMktres10_lag_7_median&#39;</span><span class="p">,</span>
       <span class="s1">&#39;returnsClosePrevMktres10_lag_7_max&#39;</span><span class="p">,</span>
       <span class="s1">&#39;returnsClosePrevMktres10_lag_7_min&#39;</span><span class="p">,</span>
       <span class="s1">&#39;returnsClosePrevMktres10_lag_14_median&#39;</span><span class="p">,</span>
       <span class="s1">&#39;returnsClosePrevMktres10_lag_14_max&#39;</span><span class="p">,</span>
       <span class="s1">&#39;returnsClosePrevMktres10_lag_14_min&#39;</span><span class="p">,</span>
       <span class="s1">&#39;returnsClosePrevRaw10_lag_3_median&#39;</span><span class="p">,</span> <span class="s1">&#39;returnsClosePrevRaw10_lag_3_max&#39;</span><span class="p">,</span>
       <span class="s1">&#39;returnsClosePrevRaw10_lag_3_min&#39;</span><span class="p">,</span> <span class="s1">&#39;returnsClosePrevRaw10_lag_7_median&#39;</span><span class="p">,</span>
       <span class="s1">&#39;returnsClosePrevRaw10_lag_7_max&#39;</span><span class="p">,</span> <span class="s1">&#39;returnsClosePrevRaw10_lag_7_min&#39;</span><span class="p">,</span>
       <span class="s1">&#39;returnsClosePrevRaw10_lag_14_median&#39;</span><span class="p">,</span>
       <span class="s1">&#39;returnsClosePrevRaw10_lag_14_max&#39;</span><span class="p">,</span> <span class="s1">&#39;returnsClosePrevRaw10_lag_14_min&#39;</span><span class="p">,</span>
       <span class="s1">&#39;open_lag_3_median&#39;</span><span class="p">,</span> <span class="s1">&#39;open_lag_3_max&#39;</span><span class="p">,</span> <span class="s1">&#39;open_lag_3_min&#39;</span><span class="p">,</span>
       <span class="s1">&#39;open_lag_7_median&#39;</span><span class="p">,</span> <span class="s1">&#39;open_lag_7_max&#39;</span><span class="p">,</span> <span class="s1">&#39;open_lag_7_min&#39;</span><span class="p">,</span>
       <span class="s1">&#39;open_lag_14_median&#39;</span><span class="p">,</span> <span class="s1">&#39;open_lag_14_max&#39;</span><span class="p">,</span> <span class="s1">&#39;open_lag_14_min&#39;</span><span class="p">,</span>
       <span class="s1">&#39;close_lag_3_median&#39;</span><span class="p">,</span> <span class="s1">&#39;close_lag_3_max&#39;</span><span class="p">,</span> <span class="s1">&#39;close_lag_3_min&#39;</span><span class="p">,</span>
       <span class="s1">&#39;close_lag_7_median&#39;</span><span class="p">,</span> <span class="s1">&#39;close_lag_7_max&#39;</span><span class="p">,</span> <span class="s1">&#39;close_lag_7_min&#39;</span><span class="p">,</span>
       <span class="s1">&#39;close_lag_14_median&#39;</span><span class="p">,</span> <span class="s1">&#39;close_lag_14_max&#39;</span><span class="p">,</span> <span class="s1">&#39;close_lag_14_min&#39;</span><span class="p">,</span>
       <span class="s1">&#39;closeopentovolume&#39;</span><span class="p">,</span> <span class="s1">&#39;meanvolume&#39;</span><span class="p">,</span> <span class="s1">&#39;meanclose&#39;</span><span class="p">,</span> <span class="s1">&#39;stdclose&#39;</span><span class="p">,</span><span class="s1">&#39;close_30EMA&#39;</span><span class="p">,</span> <span class="s1">&#39;close_26EMA&#39;</span><span class="p">,</span> <span class="s1">&#39;close_12EMA&#39;</span><span class="p">,</span>
       <span class="s1">&#39;MACD&#39;</span><span class="p">,</span> <span class="s1">&#39;MA_7MA&#39;</span><span class="p">,</span> <span class="s1">&#39;MA_7MA_std&#39;</span><span class="p">,</span> <span class="s1">&#39;MA_7MA_BB_high&#39;</span><span class="p">,</span> <span class="s1">&#39;MA_7MA_BB_low&#39;</span><span class="p">,</span>
       <span class="s1">&#39;RSI&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;sin_quarter&#39;</span><span class="p">,</span> <span class="s1">&#39;sin_dayofweek&#39;</span><span class="p">,</span> <span class="s1">&#39;sin_month&#39;</span><span class="p">,</span><span class="s1">&#39;year&#39;</span><span class="p">]</span>
<span class="n">X_train</span><span class="o">=</span><span class="n">traindata</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
<span class="n">X_test</span><span class="o">=</span><span class="n">testdata</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">corr</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
<span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices_from</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">diverging_palette</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">as_cmap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shrink&quot;</span><span class="p">:</span> <span class="mf">.5</span><span class="p">})</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x1ea4062aac8&gt;
</code></pre></div>
<p><img alt="png" src="../output_10_1.png" /></p>
<h2 id="defining-custom-metric-functions">Defining custom metric functions<a class="headerlink" href="#defining-custom-metric-functions" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sigma_score</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span><span class="n">valid_data</span><span class="p">):</span>
    <span class="n">pred</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)):</span>
        <span class="n">df_time</span> <span class="o">=</span> <span class="n">time_test</span><span class="o">.</span><span class="n">factorize</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">universe</span><span class="o">=</span><span class="n">universe_test</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">y_test1</span><span class="o">*</span><span class="n">universe</span>
    <span class="k">elif</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)):</span>
        <span class="n">df_time</span> <span class="o">=</span> <span class="n">time_train</span><span class="o">.</span><span class="n">factorize</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">universe</span><span class="o">=</span><span class="n">universe_train</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">y_train1</span><span class="o">*</span><span class="n">universe</span>
    <span class="n">x_t</span> <span class="o">=</span> <span class="n">pred</span> <span class="o">*</span> <span class="n">labels</span>
    <span class="n">x_t_sum</span> <span class="o">=</span> <span class="n">x_t</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df_time</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">x_t_sum</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">x_t_sum</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;sigma_score&#39;</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="kc">True</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sigma_score_2</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">valid_data</span><span class="p">):</span>
    <span class="n">preds</span><span class="o">=</span><span class="n">preds</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)):</span>
        <span class="n">df_time</span><span class="o">=</span> <span class="n">time_train</span><span class="o">.</span><span class="n">factorize</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">y_train1</span>
        <span class="n">x_t</span> <span class="o">=</span> <span class="n">preds</span><span class="o">*</span><span class="n">labels</span><span class="o">*</span><span class="n">universe_train</span>
<span class="c1">#    df_time = valid_data.params[&#39;extra_time&#39;]</span>
<span class="c1">#    labels = valid_data.get_label()</span>
    <span class="k">elif</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)):</span>
        <span class="n">df_time</span><span class="o">=</span> <span class="n">time_test</span><span class="o">.</span><span class="n">factorize</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">y_test1</span>
        <span class="n">x_t</span> <span class="o">=</span> <span class="n">preds</span><span class="o">*</span><span class="n">labels</span><span class="o">*</span><span class="n">universe_test</span>

   <span class="c1"># labels=y_test</span>
 <span class="c1">#   preds=pd.DataFrame(preds).clip(-1,1).values</span>
  <span class="c1">#  preds=preds.reshape(len(preds), )</span>
<span class="c1">#    assert len(labels) == len(df_time)</span>
    <span class="c1">#  * df_valid[&#39;universe&#39;] -&gt; Here we take out the &#39;universe&#39; term because we already keep only those equals to 1.</span>

    <span class="c1"># Here we take advantage of the fact that `labels` (used to calculate `x_t`)</span>
    <span class="c1"># is a pd.Series and call `group_by`</span>
    <span class="n">x_t_sum</span> <span class="o">=</span> <span class="n">x_t</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df_time</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">x_t_sum</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">x_t_sum</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="k">return</span> <span class="s1">&#39;sigma_score&#39;</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="kc">True</span>
</code></pre></div>
<h2 id="time-series-split">Time series split<a class="headerlink" href="#time-series-split" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="n">tscv</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>
<h1 id="classifiers">Classifiers<a class="headerlink" href="#classifiers" title="Permanent link">&para;</a></h1>
<h2 id="logistic-regression">Logistic regression<a class="headerlink" href="#logistic-regression" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="n">model</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>C:\Users\chinn\Anaconda3\lib\site-packages\sklearn\linear_model\logistic.py:433: FutureWarning: Default solver will be changed to &#39;lbfgs&#39; in 0.22. Specify a solver to silence this warning.
  FutureWarning)





LogisticRegression(C=1.0, class_weight=None, dual=False, fit_intercept=True,
          intercept_scaling=1, max_iter=100, multi_class=&#39;warn&#39;,
          n_jobs=None, penalty=&#39;l2&#39;, random_state=None, solver=&#39;warn&#39;,
          tol=0.0001, verbose=0, warm_start=False)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">sigma_score</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y_test1</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.37416417744774055, True)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>

<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span> 
    <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span>
    <span class="s1">&#39;penalty&#39;</span><span class="p">:[</span><span class="s1">&#39;l2&#39;</span><span class="p">]</span>
   <span class="p">}</span>

<span class="n">rfc</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="n">param_distributions</span> <span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span> <span class="n">tscv</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">scoring</span> <span class="o">=</span><span class="s1">&#39;neg_log_loss&#39;</span><span class="p">)</span>
<span class="n">rfc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span>
<span class="n">sigma_score</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span><span class="n">y_test1</span><span class="p">)</span>
</code></pre></div>
<h2 id="random-forest">Random forest<a class="headerlink" href="#random-forest" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="n">clf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">model</span><span class="o">=</span><span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>C:\Users\chinn\Anaconda3\lib\site-packages\sklearn\ensemble\forest.py:246: FutureWarning: The default value of n_estimators will change from 10 in version 0.20 to 100 in 0.22.
  &quot;10 in version 0.20 to 100 in 0.22.&quot;, FutureWarning)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span>
<span class="n">sigma_score</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span><span class="n">y_test1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.3750540242407995, True)
</code></pre></div>
<h2 id="calibrated-on-rf">Calibrated on RF<a class="headerlink" href="#calibrated-on-rf" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalibratedClassifierCV</span>
<span class="n">calibrated_clf</span> <span class="o">=</span> <span class="n">CalibratedClassifierCV</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">tscv</span><span class="p">)</span>
<span class="n">calibrated_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>CalibratedClassifierCV(base_estimator=RandomForestClassifier(bootstrap=True, class_weight=None, criterion=&#39;gini&#39;,
            max_depth=None, max_features=&#39;auto&#39;, max_leaf_nodes=None,
            min_impurity_decrease=0.0, min_impurity_split=None,
            min_samples_leaf=1, min_samples_split=2,
            min_weight_fraction_leaf=0.0, n_estimators=10, n_jobs=-1,
            oob_score=False, random_state=None, verbose=0,
            warm_start=False),
            cv=TimeSeriesSplit(max_train_size=None, n_splits=2),
            method=&#39;sigmoid&#39;)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">Ytrainpred</span><span class="o">=</span><span class="n">calibrated_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">Ytestpred</span><span class="o">=</span><span class="n">calibrated_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">ytrainpred</span><span class="o">=</span><span class="n">Ytrainpred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ytestpred</span><span class="o">=</span><span class="n">Ytestpred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sigma_score</span><span class="p">(</span><span class="n">ytrainpred</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y_train1</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 1.1045316341808502, True)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sigma_score</span><span class="p">(</span><span class="n">ytestpred</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y_train1</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.4862011486445091, True)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">feature_importances</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span>
                                   <span class="n">index</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">feature_importances</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>importance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>sin_dayofweek</th>
      <td>0.006310</td>
    </tr>
    <tr>
      <th>sin_quarter</th>
      <td>0.003783</td>
    </tr>
    <tr>
      <th>stdclose</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>meanclose</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>meanvolume</th>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="grid-search-on-rf">Grid search on RF<a class="headerlink" href="#grid-search-on-rf" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="n">clf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span> 
    <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">300</span><span class="p">,</span><span class="mi">500</span><span class="p">],</span>
    <span class="s1">&#39;max_depth&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span>
<span class="p">}</span>

<span class="n">rfc</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span> <span class="n">param_distributions</span> <span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span> <span class="n">tscv</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">scoring</span> <span class="o">=</span><span class="s1">&#39;neg_log_loss&#39;</span><span class="p">)</span>
<span class="n">rfc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>RandomizedSearchCV(cv=TimeSeriesSplit(max_train_size=None, n_splits=2),
          error_score=&#39;raise-deprecating&#39;,
          estimator=RandomForestClassifier(bootstrap=True, class_weight=None, criterion=&#39;gini&#39;,
            max_depth=None, max_features=&#39;auto&#39;, max_leaf_nodes=None,
            min_impurity_decrease=0.0, min_impurity_split=None,
            min_samples_leaf=1, min_samples_split=2,
            min_weight_fraction_leaf=0.0, n_estimators=&#39;warn&#39;, n_jobs=-1,
            oob_score=False, random_state=None, verbose=0,
            warm_start=False),
          fit_params=None, iid=&#39;warn&#39;, n_iter=10, n_jobs=-1,
          param_distributions={&#39;n_estimators&#39;: [100, 200, 300, 500], &#39;max_depth&#39;: [4, 5, 6, 7, 8]},
          pre_dispatch=&#39;2*n_jobs&#39;, random_state=None, refit=True,
          return_train_score=&#39;warn&#39;, scoring=&#39;neg_log_loss&#39;, verbose=0)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">rfc</span><span class="o">.</span><span class="n">best_params_</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>{&#39;n_estimators&#39;: 300, &#39;max_depth&#39;: 8}
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">rfc</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sigma_score</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span><span class="n">y_train1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.7134924265006625, True)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">rfc</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span>
<span class="n">sigma_score</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">y_test1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.5346658390165596, True)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>C:\Users\chinn\Anaconda3\lib\site-packages\scipy\stats\stats.py:1713: FutureWarning: Using a non-tuple sequence for multidimensional indexing is deprecated; use `arr[tuple(seq)]` instead of `arr[seq]`. In the future this will be interpreted as an array index, `arr[np.array(seq)]`, which will result either in an error or a different result.
  return np.add.reduce(sorted[indexer] * weights, axis=axis) / sumval





&lt;matplotlib.axes._subplots.AxesSubplot at 0x1ea4b178550&gt;
</code></pre></div>
<p><img alt="png" src="../output_40_2.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">y_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([[173933, 189148],
       [136749, 217843]], dtype=int64)
</code></pre></div>
<h1 id="calibrated-on-tuned-model">Calibrated on tuned model<a class="headerlink" href="#calibrated-on-tuned-model" title="Permanent link">&para;</a></h1>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalibratedClassifierCV</span>
<span class="n">clf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">calibrated_clf</span> <span class="o">=</span> <span class="n">CalibratedClassifierCV</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">tscv</span><span class="p">)</span>
<span class="n">calibrated_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>CalibratedClassifierCV(base_estimator=RandomForestClassifier(bootstrap=True, class_weight=None, criterion=&#39;gini&#39;,
            max_depth=7, max_features=&#39;auto&#39;, max_leaf_nodes=None,
            min_impurity_decrease=0.0, min_impurity_split=None,
            min_samples_leaf=1, min_samples_split=2,
            min_weight_fraction_leaf=0.0, n_estimators=300, n_jobs=None,
            oob_score=False, random_state=None, verbose=0,
            warm_start=False),
            cv=TimeSeriesSplit(max_train_size=None, n_splits=2),
            method=&#39;sigmoid&#39;)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">calibrated_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sigma_score</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y_test1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.5485461670781893, True)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">calibrated_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">sigma_score</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y_train1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.6121033369983073, True)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span><span class="n">y_pred</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([[      0, 1280993],
       [      0, 1341474]], dtype=int64)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">calibrated_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x1f8569cdd30&gt;
</code></pre></div>
<p><img alt="png" src="../output_51_1.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">train_cols</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="c1"># Note: y data is expected to be a pandas Series, as we will use its group_by function in `sigma_score`</span>
<span class="n">dtrain</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span><span class="n">feature_name</span><span class="o">=</span><span class="n">train_cols</span><span class="p">,</span><span class="n">free_raw_data</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">dvalid</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span><span class="n">feature_name</span><span class="o">=</span><span class="n">train_cols</span><span class="p">,</span> <span class="n">free_raw_data</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;boosting_type&#39;</span><span class="p">:</span> <span class="s1">&#39;gbdt&#39;</span><span class="p">,</span>
          <span class="s1">&#39;max_depth&#39;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
          <span class="s1">&#39;objective&#39;</span><span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
          <span class="s1">&#39;nthread&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="c1"># Updated from nthread</span>
          <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
          <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
          <span class="s1">&#39;max_bin&#39;</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span>
          <span class="s1">&#39;subsample_for_bin&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
          <span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="s1">&#39;subsample_freq&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
          <span class="s1">&#39;reg_alpha&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
          <span class="s1">&#39;reg_lambda&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
          <span class="s1">&#39;min_split_gain&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
          <span class="s1">&#39;min_child_weight&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="s1">&#39;min_child_samples&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
          <span class="s1">&#39;scale_pos_weight&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="s1">&#39;num_class&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="s1">&#39;metric&#39;</span> <span class="p">:</span> <span class="s1">&#39;binary_error&#39;</span><span class="p">}</span>

<span class="c1"># Create parameters to search</span>
<span class="n">gridParams</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.005</span><span class="p">],</span>
    <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span><span class="mi">150</span><span class="p">],</span>
    <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span>
    <span class="s1">&#39;boosting_type&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;gbdt&#39;</span><span class="p">],</span>
    <span class="s1">&#39;objective&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;binary&#39;</span><span class="p">],</span>
    <span class="s1">&#39;random_state&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">501</span><span class="p">],</span> <span class="c1"># Updated from &#39;seed&#39;</span>
    <span class="s1">&#39;colsample_bytree&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="mf">0.65</span><span class="p">,</span> <span class="mf">0.66</span><span class="p">],</span>
    <span class="s1">&#39;subsample&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.75</span><span class="p">],</span>
    <span class="s1">&#39;reg_alpha&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.2</span><span class="p">],</span>
    <span class="s1">&#39;reg_lambda&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.2</span><span class="p">,</span><span class="mf">1.4</span><span class="p">],</span>
    <span class="p">}</span>

<span class="c1"># Create classifier to use. Note that parameters have to be input manually</span>
<span class="c1"># not as a dict!</span>
<span class="n">evals_result</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">mdl</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span><span class="n">boosting_type</span><span class="o">=</span> <span class="s1">&#39;gbdt&#39;</span><span class="p">,</span>
          <span class="n">objective</span> <span class="o">=</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
          <span class="n">n_jobs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
          <span class="n">silent</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
          <span class="n">max_depth</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;max_depth&#39;</span><span class="p">],</span>
          <span class="n">max_bin</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;max_bin&#39;</span><span class="p">],</span>
          <span class="n">subsample_for_bin</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;subsample_for_bin&#39;</span><span class="p">],</span>
          <span class="n">subsample</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;subsample&#39;</span><span class="p">],</span>
          <span class="n">subsample_freq</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;subsample_freq&#39;</span><span class="p">],</span>
          <span class="n">min_split_gain</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;min_split_gain&#39;</span><span class="p">],</span>
          <span class="n">min_child_weight</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;min_child_weight&#39;</span><span class="p">],</span>
          <span class="n">min_child_samples</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;min_child_samples&#39;</span><span class="p">],</span>
          <span class="n">scale_pos_weight</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;scale_pos_weight&#39;</span><span class="p">])</span>

<span class="c1"># To view the default model params:</span>
<span class="n">mdl</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

<span class="c1"># Create the grid</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">mdl</span><span class="p">,</span> <span class="n">gridParams</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">cv</span><span class="o">=</span><span class="n">tscv</span><span class="p">,</span>
                    <span class="n">n_jobs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_log_loss&#39;</span><span class="p">)</span>
<span class="c1"># Run the grid</span>
<span class="n">grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Print the best parameters found</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>{&#39;subsample&#39;: 0.75, &#39;reg_lambda&#39;: 1.2, &#39;reg_alpha&#39;: 1, &#39;random_state&#39;: 501, &#39;objective&#39;: &#39;binary&#39;, &#39;num_leaves&#39;: 12, &#39;n_estimators&#39;: 150, &#39;learning_rate&#39;: 0.005, &#39;colsample_bytree&#39;: 0.66, &#39;boosting_type&#39;: &#39;gbdt&#39;}
-0.6895867716593379
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">x_1</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.19000424246380565</span><span class="p">,</span> <span class="mi">2452</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">328</span><span class="p">,</span> <span class="mi">202</span><span class="p">]</span>

<span class="n">params_1</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
        <span class="s1">&#39;boosting_type&#39;</span><span class="p">:</span> <span class="s1">&#39;gbdt&#39;</span><span class="p">,</span>
        <span class="s1">&#39;objective&#39;</span><span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span>
        <span class="s1">&#39;num_iteration&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
        <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span><span class="mi">150</span><span class="p">,</span>
        <span class="s1">&#39;colsample_bytree&#39;</span><span class="p">:</span> <span class="mf">0.66</span><span class="p">,</span> 
         <span class="s1">&#39;subsample&#39;</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">,</span>
        <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="s1">&#39;metric&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;reg_lambda&#39;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>
    <span class="s1">&#39;reg_alpha&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="mi">501</span><span class="p">,</span>
    <span class="s1">&#39;objective&#39;</span><span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
    <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">12</span>
    <span class="p">}</span>


<span class="n">gbm_1</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">params_1</span><span class="p">,</span>
        <span class="n">dtrain</span><span class="p">,</span>
        <span class="n">num_boost_round</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">valid_sets</span><span class="o">=</span><span class="n">dvalid</span><span class="p">,</span>
        <span class="n">feval</span><span class="o">=</span><span class="n">sigma_score_2</span><span class="p">,</span>
        <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">verbose_eval</span><span class="o">=</span><span class="mi">25</span>
        <span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>C:\Users\chinn\Anaconda3\lib\site-packages\lightgbm\engine.py:113: UserWarning: Found `num_iteration` in params. Will use it instead of argument
  warnings.warn(&quot;Found `{}` in params. Will use it instead of argument&quot;.format(alias))


Training until validation scores don&#39;t improve for 30 rounds.
[25]    valid_0&#39;s binary_logloss: 0.692633  valid_0&#39;s sigma_score: 0.0795633
[50]    valid_0&#39;s binary_logloss: 0.691774  valid_0&#39;s sigma_score: 0.273122
[75]    valid_0&#39;s binary_logloss: 0.691024  valid_0&#39;s sigma_score: 0.397076
[100]   valid_0&#39;s binary_logloss: 0.690331  valid_0&#39;s sigma_score: 0.477671
[125]   valid_0&#39;s binary_logloss: 0.689849  valid_0&#39;s sigma_score: 0.52121
[150]   valid_0&#39;s binary_logloss: 0.689309  valid_0&#39;s sigma_score: 0.551341
[175]   valid_0&#39;s binary_logloss: 0.688996  valid_0&#39;s sigma_score: 0.562054
[200]   valid_0&#39;s binary_logloss: 0.688644  valid_0&#39;s sigma_score: 0.572705
[225]   valid_0&#39;s binary_logloss: 0.688447  valid_0&#39;s sigma_score: 0.573533
[250]   valid_0&#39;s binary_logloss: 0.688145  valid_0&#39;s sigma_score: 0.579904
[275]   valid_0&#39;s binary_logloss: 0.687972  valid_0&#39;s sigma_score: 0.579298
Early stopping, best iteration is:
[254]   valid_0&#39;s binary_logloss: 0.688098  valid_0&#39;s sigma_score: 0.580737
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
<span class="n">lgb</span><span class="o">.</span><span class="n">plot_importance</span><span class="p">(</span><span class="n">gbm_1</span><span class="p">,</span><span class="n">max_num_features</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;Figure size 2880x1440 with 0 Axes&gt;
</code></pre></div>
<p><img alt="png" src="../output_55_1.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">gbm_1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sigma_score</span><span class="p">(</span><span class="n">y_pred</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y_train1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.6859160729981825, True)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">gbm_1</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sigma_score</span><span class="p">(</span><span class="n">y_pred</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y_test1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.5807365552305024, True)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">y_pred</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x1f8875b84e0&gt;
</code></pre></div>
<p><img alt="png" src="../output_60_1.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">clf</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span><span class="n">task</span><span class="o">=</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span>
        <span class="n">boosting_type</span><span class="o">=</span> <span class="s1">&#39;gbdt&#39;</span><span class="p">,</span>
        <span class="n">objective</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="o">=</span> <span class="mf">0.005</span><span class="p">,</span>
        <span class="n">num_iteration</span><span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
        <span class="n">n_estimators</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
        <span class="n">colsample_bytree</span><span class="o">=</span> <span class="mf">0.66</span><span class="p">,</span> 
        <span class="n">subsample</span><span class="o">=</span> <span class="mf">0.75</span><span class="p">,</span>
        <span class="n">verbose</span> <span class="o">=</span><span class="mi">1</span><span class="p">,</span>
         <span class="n">reg_lambda</span><span class="o">=</span> <span class="mf">1.2</span><span class="p">,</span>
    <span class="n">reg_alpha</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span> <span class="mi">501</span><span class="p">,</span>
    <span class="n">num_leaves</span><span class="o">=</span> <span class="mi">12</span>
<span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">calibrated_clf</span> <span class="o">=</span> <span class="n">CalibratedClassifierCV</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;isotonic&#39;</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">tscv</span><span class="p">)</span>
<span class="n">calibrated_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>C:\Users\chinn\Anaconda3\lib\site-packages\lightgbm\engine.py:113: UserWarning: Found `num_iteration` in params. Will use it instead of argument
  warnings.warn(&quot;Found `{}` in params. Will use it instead of argument&quot;.format(alias))
C:\Users\chinn\Anaconda3\lib\site-packages\lightgbm\engine.py:113: UserWarning: Found `num_iteration` in params. Will use it instead of argument
  warnings.warn(&quot;Found `{}` in params. Will use it instead of argument&quot;.format(alias))





CalibratedClassifierCV(base_estimator=LGBMClassifier(boosting_type=&#39;gbdt&#39;, class_weight=None, colsample_bytree=0.66,
        importance_type=&#39;split&#39;, learning_rate=0.005, max_depth=-1,
        min_child_samples=20, min_child_weight=0.001, min_split_gain=0.0,
        n_estimators=150, n_jobs=-1, num_iteration=500, num_leaves=12,
        objective=&#39;binary&#39;, random_state=501, reg_alpha=1, reg_lambda=1.2,
        silent=True, subsample=0.75, subsample_for_bin=200000,
        subsample_freq=0, task=&#39;train&#39;, verbose=1),
            cv=TimeSeriesSplit(max_train_size=None, n_splits=2),
            method=&#39;isotonic&#39;)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">Ytrainpred</span><span class="o">=</span><span class="n">calibrated_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">Ytestpred</span><span class="o">=</span><span class="n">calibrated_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">ytrainpred</span><span class="o">=</span><span class="n">Ytrainpred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ytestpred</span><span class="o">=</span><span class="n">Ytestpred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sigma_score</span><span class="p">(</span><span class="n">ytrainpred</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y_train1</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.6237107583636623, True)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sigma_score</span><span class="p">(</span><span class="n">ytestpred</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y_train1</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.5677100719773357, True)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">xgb</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">objective</span><span class="o">=</span><span class="s1">&#39;binary:logistic&#39;</span><span class="p">,</span>
                    <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nthread</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">model</span><span class="o">=</span><span class="n">xgb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">xgb</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sigma_score</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y_test1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.48366598850149906, True)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">xgb</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">sigma_score</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y_train1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.8113740249829478, True)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span><span class="n">y_pred</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([[601906, 679087],
       [447189, 894285]], dtype=int64)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">xgb</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">objective</span><span class="o">=</span><span class="s1">&#39;binary:logistic&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">clf</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">xgb</span><span class="p">,{</span><span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span>
                    <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">]},</span> 
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                    <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_log_loss&#39;</span><span class="p">,</span>
                   <span class="n">cv</span><span class="o">=</span> <span class="n">tscv</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
                     <span class="p">)</span>

<span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">)</span>
<span class="n">clf</span><span class="o">.</span><span class="n">best_score_</span><span class="p">,</span> <span class="n">clf</span><span class="o">.</span><span class="n">best_params_</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>C:\Users\chinn\Anaconda3\lib\site-packages\sklearn\model_selection\_search.py:271: UserWarning: The total space of parameters 9 is smaller than n_iter=10. Running 9 iterations. For exhaustive searches, use GridSearchCV.
  % (grid_size, self.n_iter, grid_size), UserWarning)
[Parallel(n_jobs=-1)]: Using backend LokyBackend with 4 concurrent workers.


Fitting 2 folds for each of 9 candidates, totalling 18 fits


[Parallel(n_jobs=-1)]: Done  18 out of  18 | elapsed: 167.0min finished





(-0.6870596950771145, {&#39;n_estimators&#39;: 50, &#39;max_depth&#39;: 2})
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sigma_score</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y_test1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.5466463282705594, True)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">sigma_score</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y_train1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.6633845835678877, True)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">0</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span><span class="n">y_pred</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([[      0, 1280993],
       [      0, 1341474]], dtype=int64)
</code></pre></div>
<h1 id="calibrated-on-xg-boost">Calibrated on XG BOOST<a class="headerlink" href="#calibrated-on-xg-boost" title="Permanent link">&para;</a></h1>
<div class="highlight"><pre><span></span><code><span class="n">xgb</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">objective</span><span class="o">=</span><span class="s1">&#39;binary:logistic&#39;</span><span class="p">,</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.calibration</span><span class="w"> </span><span class="kn">import</span> <span class="n">CalibratedClassifierCV</span>
<span class="n">calibrated_clf</span> <span class="o">=</span> <span class="n">CalibratedClassifierCV</span><span class="p">(</span><span class="n">xgb</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">tscv</span><span class="p">)</span>
<span class="n">calibrated_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>CalibratedClassifierCV(base_estimator=XGBClassifier(base_score=0.5, booster=&#39;gbtree&#39;, colsample_bylevel=1,
       colsample_bytree=1, gamma=0, learning_rate=0.1, max_delta_step=0,
       max_depth=2, min_child_weight=1, missing=None, n_estimators=50,
       n_jobs=1, nthread=None, objective=&#39;binary:logistic&#39;, random_state=0,
       reg_alpha=0, reg_lambda=1, scale_pos_weight=1, seed=None,
       silent=True, subsample=1),
            cv=TimeSeriesSplit(max_train_size=None, n_splits=2),
            method=&#39;sigmoid&#39;)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">Ytrainpred</span><span class="o">=</span><span class="n">calibrated_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">Ytestpred</span><span class="o">=</span><span class="n">calibrated_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">ytrainpred</span><span class="o">=</span><span class="n">Ytrainpred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ytestpred</span><span class="o">=</span><span class="n">Ytestpred</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sigma_score</span><span class="p">(</span><span class="n">ytrainpred</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y_train1</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.5896574335387855, True)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sigma_score</span><span class="p">(</span><span class="n">ytestpred</span><span class="o">*</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y_test1</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.549996122565269, True)
</code></pre></div>
<h1 id="using-regression">Using regression<a class="headerlink" href="#using-regression" title="Permanent link">&para;</a></h1>
<div class="highlight"><pre><span></span><code><span class="n">train_cols</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Note: y data is expected to be a pandas Series, as we will use its group_by function in `sigma_score`</span>
<span class="n">dtrain</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">y_train1</span><span class="p">,</span><span class="n">feature_name</span><span class="o">=</span><span class="n">train_cols</span><span class="p">,</span> <span class="n">free_raw_data</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">dvalid</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">y_test1</span><span class="p">,</span><span class="n">feature_name</span><span class="o">=</span><span class="n">train_cols</span><span class="p">,</span><span class="n">free_raw_data</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">lgb_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">objective</span> <span class="o">=</span> <span class="s1">&#39;regression_l1&#39;</span><span class="p">,</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.005</span><span class="p">,</span>
    <span class="n">bagging_fraction</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">,</span>
    <span class="n">bagging_freq</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">feature_fraction</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">num_iteration</span><span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
    <span class="n">colsample_bytree</span><span class="o">=</span> <span class="mf">0.66</span><span class="p">,</span> 
    <span class="n">subsample</span><span class="o">=</span> <span class="mf">0.75</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">reg_lambda</span><span class="o">=</span> <span class="mf">1.2</span><span class="p">,</span>
    <span class="n">reg_alpha</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span> <span class="mi">501</span><span class="p">,</span>
    <span class="n">num_leaves</span><span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
    <span class="n">lambda_l1</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">lambda_l2</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="c1"># This will ignore the loss objetive and use sigma_score instead,</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Change for better luck! :)</span>
<span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">evals_result</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">lgb_params</span><span class="p">,</span> <span class="n">dtrain</span><span class="p">,</span> <span class="n">num_boost_round</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">valid_sets</span><span class="o">=</span><span class="p">(</span><span class="n">dtrain</span><span class="p">,</span><span class="n">dvalid</span><span class="p">),</span> <span class="n">valid_names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span><span class="s1">&#39;valid&#39;</span><span class="p">),</span> <span class="n">verbose_eval</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">feval</span><span class="o">=</span><span class="n">sigma_score</span><span class="p">,</span> <span class="n">evals_result</span><span class="o">=</span><span class="n">evals_result</span><span class="p">)</span>
<span class="n">df_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">evals_result</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">])</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>C:\Users\chinn\Anaconda3\lib\site-packages\lightgbm\engine.py:113: UserWarning: Found `num_iteration` in params. Will use it instead of argument
  warnings.warn(&quot;Found `{}` in params. Will use it instead of argument&quot;.format(alias))


[25]    train&#39;s sigma_score: 0.418809   valid&#39;s sigma_score: 0.117999
[50]    train&#39;s sigma_score: 0.568597   valid&#39;s sigma_score: 0.307166
[75]    train&#39;s sigma_score: 0.620927   valid&#39;s sigma_score: 0.421572
[100]   train&#39;s sigma_score: 0.635875   valid&#39;s sigma_score: 0.482216
[125]   train&#39;s sigma_score: 0.636294   valid&#39;s sigma_score: 0.512729
[150]   train&#39;s sigma_score: 0.638908   valid&#39;s sigma_score: 0.531243
[175]   train&#39;s sigma_score: 0.636937   valid&#39;s sigma_score: 0.5422
[200]   train&#39;s sigma_score: 0.637198   valid&#39;s sigma_score: 0.547239
[225]   train&#39;s sigma_score: 0.635802   valid&#39;s sigma_score: 0.551443
[250]   train&#39;s sigma_score: 0.632717   valid&#39;s sigma_score: 0.554628
[275]   train&#39;s sigma_score: 0.633287   valid&#39;s sigma_score: 0.554167
[300]   train&#39;s sigma_score: 0.634656   valid&#39;s sigma_score: 0.556521
[325]   train&#39;s sigma_score: 0.63648    valid&#39;s sigma_score: 0.556715
[350]   train&#39;s sigma_score: 0.637532   valid&#39;s sigma_score: 0.55786
[375]   train&#39;s sigma_score: 0.636781   valid&#39;s sigma_score: 0.558729
[400]   train&#39;s sigma_score: 0.637117   valid&#39;s sigma_score: 0.558295
[425]   train&#39;s sigma_score: 0.637578   valid&#39;s sigma_score: 0.558153
[450]   train&#39;s sigma_score: 0.638075   valid&#39;s sigma_score: 0.558225
[475]   train&#39;s sigma_score: 0.637123   valid&#39;s sigma_score: 0.558062
[500]   train&#39;s sigma_score: 0.636048   valid&#39;s sigma_score: 0.557664
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x1f88893d978&gt;
</code></pre></div>
<p><img alt="png" src="../output_95_1.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
<span class="n">lgb</span><span class="o">.</span><span class="n">plot_importance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">lgb</span><span class="o">.</span><span class="n">plot_importance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">importance_type</span><span class="o">=</span><span class="s1">&#39;gain&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="../output_96_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">clf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">model</span><span class="o">=</span><span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="n">y_train1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sigma_score</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span><span class="n">y_test1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&#39;sigma_score&#39;, 0.3476250043396745, True)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">feature_importances</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span>
                                   <span class="n">index</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">feature_importances</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>importance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>returnsClosePrevMktres10_lag_14_min</th>
      <td>0.267275</td>
    </tr>
    <tr>
      <th>close_30EMA</th>
      <td>0.132671</td>
    </tr>
    <tr>
      <th>close_26EMA</th>
      <td>0.131267</td>
    </tr>
    <tr>
      <th>returnsOpenPrevMktres1</th>
      <td>0.044182</td>
    </tr>
    <tr>
      <th>returnsOpenPrevRaw10</th>
      <td>0.037511</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><code><span class="c1">#model = RandomForestRegressor()</span>
<span class="c1">#param_grid = { </span>
<span class="c1">#    &#39;n_estimators&#39;: [100,250,500],</span>
<span class="c1">#    &#39;max_depth&#39; : [3,5,7],</span>
<span class="c1">#}</span>
<span class="c1">#rfc = GridSearchCV(estimator=model, param_distributions =param_grid, cv= tscv,n_jobs=2)</span>
<span class="c1">#rfc.fit(X_train, y_train)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>C:\Users\chinn\Anaconda3\lib\site-packages\sklearn\model_selection\_search.py:271: UserWarning: The total space of parameters 9 is smaller than n_iter=10. Running 9 iterations. For exhaustive searches, use GridSearchCV.
  % (grid_size, self.n_iter, grid_size), UserWarning)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">#rfc.best_params_</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">#y_pred=rfc.predict(X_test)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">#sns.distplot(y_pred)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">#sigma_score(y_pred,y_train1)</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Jingxuan Wang
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../../..", "features": ["navigation.tabs", "navigation.top", "navigation.indexes", "navigation.expand", "search.suggest", "search.highlight", "content.code.copy", "content.action.edit"], "search": "../../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../../../../mkdocs/javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>